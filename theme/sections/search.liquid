<div x-data="{show: false}" class="relative">
  <span @click="show = !show" class="absolute z-10">
    <span class="svg-wrapper">
      {{- 'icon-search.svg' | inline_asset_content -}}
    </span>
  </span>
  <div
    x-show="show"
    x-data="
          {
              search: '',
              predictiveResult: '',
              loading: true,
              sortByCategory: 'All categories',
              openSortModal: false,
              atTop: false,
              close() {this.search = ''; this.openSortModal = false; show= false},
      getSearchResults() {
        fetch(`/search/suggest?q=${this.sortByCategory !== 'All categories' ? `${this.sortByCategory} AND ` : ''}${this.search}&section_id=predictive-search&resources[type]=product,query,collection,page,article&resources[limit]=6`).then((response) => {
          if (!response.ok) {
            var error = new Error(response.status);
            this.close();
            throw error;
          }
          this.loading = false
          return response.text();
        }).then((text)=>{
          this.predictiveResult = text;

      });
      },
      lastScrollTop: 0,
        scrollDirection: 'up',

        handleScroll() {
          let currentScroll = window.pageYOffset || document.documentElement.scrollTop;
          this.atTop = (currentScroll < 50)? false: true;
          if (currentScroll > this.lastScrollTop) {
            // Scrolling down
            this.scrollDirection = 'down';
          } else {
            // Scrolling up
            this.scrollDirection = 'up';
          }

          this.lastScrollTop = currentScroll <= 0 ? 0 : currentScroll; // For mobile or negative scrolling
        }
          }
    "
    id="my-search"
    @scroll.window=" handleScroll()"

    :class="scrollDirection === 'up' ? (atTop ? 'fixed top-0 z-20' : 'relative z-20') : 'fixed top-[-10%] z-20'"
    class="w-full pb-16 pl-5 pr-5 lg:px-[96px] pt-[56px] lg:pb-[64px] bg-[#f5efe7] flex flex-col justify-center items-center transition-all duration-300 ease-in-out"
  >
    <button
      id="SearchClose"
      class="cursor-pointer h-[40px] w-[44px] p-5 absolute top-1 opacity-60 right-2"
      x-on:click="close()"
    >
      <svg width="100%" height="100%" viewBox="0 0 10 10" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M0.757812 8.75781L4.75782 4.75783M4.75782 4.75783L8.7578 0.757812M4.75782 4.75783L0.757812 0.757812M4.75782 4.75783L8.7578 8.75781" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
    </button>
    <form
      action="{{ routes.search_url }}"
      onsubmit="(e)=>e.preventDefault()"
      method="get"
      class="w-full"
    >
      <div class="relative max-w-[992px] w-full mx-auto border-[#dcd6ce] ">
        <div class="w-full border-b flex">
          <div class="relative w-[112px] md:w-[176px] py-3 pr-[4.5rem] pl-4 lg:px-2">
            <div class="group">
              <div
                x-text="sortByCategory"
                class="text-[12px] md:text-[14px] text-nowrap cursor-pointer group-hover:text-[#d7c2a5] duration-200"
                @click="openSortModal = !openSortModal"
              ></div>
              <span
                class="opacity-60 absolute w-3 h-3 top-1/2 -translate-y-1/2 flex right-[10px] group-hover:text-[#d7c2a5] duration-200"
                :class="openSortModal ?'-rotate-180':'' "
              >
                <svg
                  width="100%"
                  height="100%"
                  viewBox="0 0 9 7"
                  fill="none"
                  xmlns="http://www.w3.org/2000/svg"
                  style="fill: none;"
                >
                  <path d="M0.75 1.625L4.5 5.375L8.25 1.625" stroke="currentcolor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
              </span>
            </div>
            <div
              x-show="openSortModal"
              class="absolute top-[calc(50%+28px)] pt-[24px] pb-[28px]  left-0 z-20 bg-[#f5efe7] shadow-[0_0_6px_-4px_#574136]"
            >
              <ul
                class="text-[12px] md:text-[14px] w-full md:w-auto md:min-w-[240px] px-[28px] left-0 max-h-[240px] overflow-y-auto flex flex-col "
              >
                <li
                  @click="sortByCategory = 'All categories'; if (search !== '') getSearchResults()"
                  class="py-[4px] cursor-pointer w-fit hover:text-[#d7c2a5] relative inline-block after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-full after:h-[1px] after:bg-[#d7c2a5] after:scale-x-0 after:origin-right after:transition-transform after:duration-300 hover:after:scale-x-100 hover:after:origin-left"
                >
                  All categories
                </li>
                {%- for type in shop.types -%}
                  {%- if type != '' -%}
                    <li
                      @click="sortByCategory = '{{ type }}'; if (search !== '') getSearchResults()"
                      class="py-[4px] cursor-pointer w-fit hover:text-[#d7c2a5] relative inline-block after:content-[''] after:absolute after:left-0 after:bottom-0 after:w-full after:h-[1px] after:bg-[#d7c2a5] after:scale-x-0 after:origin-right after:transition-transform after:duration-300 hover:after:scale-x-100 hover:after:origin-left"
                    >
                      {{ type }}
                    </li>
                  {%- endif -%}
                {%- endfor -%}
              </ul>
            </div>
          </div>
          <div class="border-l border-[#dcd6cb] flex-shrink-0 lg:mb-3 mr-[8px] !block"></div>
          <input
            x-on:input.change.debounce.300ms="if (search !== '') getSearchResults()"
            placeholder="Search..."
            x-model="search"
            name="q"
            class="w-full bg-inherit focus-visible:outline-none focus-visible:shadow-none py-3 pr-[4.5rem] pl-4 lg:pl-2 lg:pr-20 text-left appearance-none relative outline-none placeholder:text-current placeholder:opacity-60"
            value="{{ search.terms | escape }}"
          >
        </div>
        <button
          class="btn-search absolute none_border w-[28px] h-[28px] p-2 top-1/2 -translate-y-1/2 opacity-60 bg-none text-current lg:right-2 right-2"
          aria-label="Search..."
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="100%"
            height="100%"
            viewBox="0 0 19 18"
            fill="none"
            style="fill: none;"
          >
            <path d="M9.2665 16.2001C13.4639 16.2001 16.8665 12.7975 16.8665 8.60009C16.8665 4.40272 13.4639 1.00009 9.2665 1.00009C5.06914 1.00009 1.6665 4.40272 1.6665 8.60009C1.6665 12.7975 5.06914 16.2001 9.2665 16.2001Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            <path d="M17.6669 16.9999L16.0669 15.3999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
        <div
          x-show="search != ''"
          x-html="predictiveResult"
          class="w-full max-w-[992px] mx-auto pt-6 absolute top-[calc(50%+12px)] z-10"
        ></div>
      </div>
    </form>
  </div>
</div>

{% schema %}
{
  "name": "Search",
  "enabled_on": {
    "templates": ["*"]
  },
  "settings": [],
  "blocks": [],
  "presets": [
    {
      "name": "Search"
    }
  ]
}
{% endschema %}
